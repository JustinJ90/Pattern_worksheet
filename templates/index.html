<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YOON Weekly Test Generator</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --yoon-red: #D6001C;       /* ìœ¤ì„ ìƒ ë©”ì¸ ë ˆë“œ */
            --yoon-black: #222222;
            --yoon-gray: #F4F4F4;
            --footer-bg: #1a1a1a;      /* í‘¸í„° ê²€ì •ìƒ‰ */
        }

        body {
            font-family: 'Noto Sans KR', sans-serif;
            background-color: var(--yoon-gray);
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        /* ë©”ì¸ ì»¨í…Œì´ë„ˆ */
        .main-wrapper {
            flex: 1;
            width: 100%;
            max-width: 850px;
            margin: 40px auto;
            padding: 0 20px;
            box-sizing: border-box;
        }

        .card {
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.08);
            padding: 40px;
            border-top: 6px solid var(--yoon-red); /* ìƒë‹¨ ë¹¨ê°„ í¬ì¸íŠ¸ */
        }

        /* í—¤ë” ìŠ¤íƒ€ì¼ (í…ìŠ¤íŠ¸ ë¡œê³ ) */
        .header {
            text-align: center;
            margin-bottom: 40px;
        }
        .brand-title {
            color: var(--yoon-red);
            font-size: 2.5rem;
            font-weight: 900;
            margin: 0;
            letter-spacing: -1px;
        }
        .brand-subtitle {
            color: #666;
            font-size: 1.1rem;
            margin-top: 5px;
            font-weight: 500;
        }

        /* êµì¬ ì„ íƒ ì„¹ì…˜ */
        .book-section {
            background-color: #FFF5F5; /* ì—°í•œ í•‘í¬ ë°°ê²½ */
            border-radius: 10px;
            padding: 25px;
            text-align: center;
            margin-bottom: 30px;
            border: 1px solid #FFD1D1;
        }
        
        .book-label {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--yoon-black);
            margin-bottom: 10px;
            display: block;
        }

        select {
            width: 100%;
            max-width: 400px;
            padding: 12px 15px;
            font-size: 1rem;
            border: 2px solid var(--yoon-red);
            border-radius: 8px;
            outline: none;
            background: white;
            cursor: pointer;
            font-family: inherit;
        }

        /* íŒ¨í„´ ë¦¬ìŠ¤íŠ¸ ì˜ì—­ */
        .pattern-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
            gap: 12px;
            margin-bottom: 30px;
            max-height: 500px;
            overflow-y: auto;
            padding: 5px;
        }

        /* ìŠ¤í¬ë¡¤ë°” ìŠ¤íƒ€ì¼ */
        .pattern-list::-webkit-scrollbar { width: 8px; }
        .pattern-list::-webkit-scrollbar-thumb { background-color: #ccc; border-radius: 4px; }

        .pattern-item {
            background: white;
            border: 1px solid #eee;
            padding: 15px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            position: relative;
        }

        .pattern-item:hover {
            border-color: var(--yoon-red);
            background-color: #FFF9F9;
            transform: translateY(-2px);
            box-shadow: 0 3px 10px rgba(0,0,0,0.05);
        }

        .pattern-item.selected {
            background-color: #FFEEEE;
            border-color: var(--yoon-red);
            box-shadow: 0 0 0 1px var(--yoon-red);
        }

        .pattern-badge {
            background-color: var(--yoon-red);
            color: white;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: bold;
            margin-right: 8px;
        }

        .pattern-text {
            font-size: 0.95rem;
            color: #333;
            font-weight: 500;
        }

        /* í•˜ë‹¨ ë²„íŠ¼ ì˜ì—­ */
        .bottom-area {
            text-align: center;
            border-top: 1px solid #eee;
            padding-top: 20px;
        }

        .count-info {
            color: #666;
            margin-bottom: 15px;
            font-size: 0.95rem;
        }
        .count-num {
            color: var(--yoon-red);
            font-weight: bold;
            font-size: 1.2rem;
        }

        .generate-btn {
            background-color: var(--yoon-red);
            color: white;
            border: none;
            padding: 16px 40px;
            font-size: 1.1rem;
            font-weight: bold;
            border-radius: 50px;
            cursor: pointer;
            transition: background 0.2s, transform 0.1s;
            box-shadow: 0 4px 15px rgba(214, 0, 28, 0.3);
            width: 100%;
            max-width: 300px;
        }
        .generate-btn:hover:not(:disabled) {
            background-color: #b00017;
            transform: translateY(-2px);
        }
        .generate-btn:disabled {
            background-color: #ccc;
            cursor: not-allowed;
            box-shadow: none;
        }

        /* í‘¸í„° (ìš”ì²­í•˜ì‹  ê²€ì •ìƒ‰ ìŠ¤íƒ€ì¼) */
        .footer {
            background-color: var(--footer-bg);
            color: #999;
            padding: 40px 20px;
            text-align: center;
            font-size: 0.8rem;
            margin-top: auto; /* í•˜ë‹¨ ê³ ì • */
        }
        .footer-logo {
            color: white;
            font-weight: bold;
            font-size: 1.2rem;
            margin-bottom: 15px;
            display: inline-block;
        }
        .footer-links {
            margin-bottom: 20px;
        }
        .footer-links a {
            color: #ccc;
            text-decoration: none;
            margin: 0 10px;
        }
        .footer-links a:hover { text-decoration: underline; color: white; }
        .footer-info span {
            display: inline-block;
            margin: 0 5px;
        }
        .footer-info { line-height: 1.6; }
        .footer-copy { margin-top: 20px; color: #666; }

    </style>
</head>
<body>

    <div class="main-wrapper">
        <div class="card">
            <div class="header">
                <h1 class="brand-title">Yoon's Weekly Pattern Test</h1>
                <div class="brand-subtitle">ì›Œí¬ì‹œíŠ¸ ìë™ ìƒì„±ê¸°</div>
            </div>

            <div class="book-section">
                <label class="book-label">ğŸ“š êµì¬ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”</label>
                <select id="bookSelect" onchange="loadPatterns()">
                    <option value="" disabled selected>ëª©ë¡ì—ì„œ êµì¬ ì„ íƒ</option>
                    {% if books %}
                        {% for book in books %}
                        <option value="{{ book }}">{{ book }}</option>
                        {% endfor %}
                    {% else %}
                        <option value="" disabled>ë“±ë¡ëœ êµì¬ê°€ ì—†ìŠµë‹ˆë‹¤ (databases í´ë” í™•ì¸)</option>
                    {% endif %}
                </select>
            </div>

            <div id="loadingMsg" style="text-align:center; display:none; color:#888; margin: 20px;">
                íŒ¨í„´ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...
            </div>

            <div class="pattern-list" id="patternList">
                <div style="text-align:center; padding:40px; color:#999; grid-column: 1/-1;">
                    ìœ„ì—ì„œ êµì¬ë¥¼ ì„ íƒí•˜ë©´ íŒ¨í„´ ëª©ë¡ì´ ë‚˜íƒ€ë‚©ë‹ˆë‹¤.
                </div>
            </div>

            <div class="bottom-area">
                <div class="count-info">
                    ì„ íƒëœ íŒ¨í„´: <span id="selectedCount" class="count-num">0</span> / 5
                </div>
                <button onclick="generatePDF()" class="generate-btn" id="genBtn" disabled>
                    ì›Œí¬ì‹œíŠ¸ ìƒì„±í•˜ê¸°
                </button>
            </div>
        </div>
    </div>

    <footer class="footer">
        <div class="footer-links">
            <a href="#">ì´ìš©ì•½ê´€</a>
            <a href="#">ê°œì¸ì •ë³´ì²˜ë¦¬ë°©ì¹¨</a>
            <a href="#">ê³ ê°ì„¼í„°</a>
        </div>
        <div class="footer-info">
            <span>(ì£¼)ìœ¤ì„ ìƒ</span> <span>|</span> <span>ëŒ€í‘œì´ì‚¬: ìœ¤ì„±</span><br>
            <span>ì„œìš¸ì‹œ ê°•ë™êµ¬ ê°•ë™ëŒ€ë¡œ 166 (ì„±ë‚´ë™)</span> <span>|</span> <span>ì‚¬ì—…ìë“±ë¡ë²ˆí˜¸: 212-81-01862</span>
        </div>
        <div class="footer-copy">
            Copyright Â© YOON ENGLISH SCHOOL. All Rights Reserved.
        </div>
    </footer>

    <script>
        let selectedPatterns = new Set();
        let currentBook = "";

        async function loadPatterns() {
            const bookSelect = document.getElementById('bookSelect');
            const filename = bookSelect.value;
            const listDiv = document.getElementById('patternList');
            const loadingMsg = document.getElementById('loadingMsg');
            
            if (!filename) return;

            currentBook = filename;
            selectedPatterns.clear();
            updateUI();
            
            listDiv.innerHTML = '';
            loadingMsg.style.display = 'block';

            try {
                const res = await fetch(`/get_patterns/${filename}`);
                const data = await res.json();
                
                loadingMsg.style.display = 'none';
                
                if (data.success) {
                    if (data.patterns.length === 0) {
                        listDiv.innerHTML = '<div style="text-align:center; padding:20px; grid-column:1/-1;">ì´ êµì¬ì—ëŠ” íŒ¨í„´ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
                        return;
                    }

                    data.patterns.forEach(p => {
                        const div = document.createElement('div');
                        div.className = 'pattern-item';
                        div.onclick = () => togglePattern(div, p.number);
                        
                        // ì²´í¬ë°•ìŠ¤ ì—†ì´ ê¹”ë”í•œ ë””ìì¸ (í´ë¦­ ì‹œ ìƒ‰ìƒ ë³€í™”ë¡œ êµ¬ë¶„)
                        div.innerHTML = `
                            <span class="pattern-badge">P.${p.number}</span>
                            <span class="pattern-text">${p.name}</span>
                            <input type="checkbox" style="display:none;"> 
                        `;
                        listDiv.appendChild(div);
                    });
                } else {
                    listDiv.innerHTML = `<div style="color:red; text-align:center;">ì˜¤ë¥˜ ë°œìƒ: ${data.error}</div>`;
                }
            } catch (e) {
                loadingMsg.style.display = 'none';
                listDiv.innerHTML = '<div style="color:red; text-align:center;">ì„œë²„ í†µì‹  ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</div>';
            }
        }

        function togglePattern(element, num) {
            const strNum = String(num);
            const checkbox = element.querySelector('input');

            if (selectedPatterns.has(strNum)) {
                selectedPatterns.delete(strNum);
                element.classList.remove('selected');
                if(checkbox) checkbox.checked = false;
            } else {
                if (selectedPatterns.size >= 5) {
                    alert('íŒ¨í„´ì€ ìµœëŒ€ 5ê°œê¹Œì§€ë§Œ ì„ íƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
                    return;
                }
                selectedPatterns.add(strNum);
                element.classList.add('selected');
                if(checkbox) checkbox.checked = true;
            }
            updateUI();
        }

        function updateUI() {
            const count = selectedPatterns.size;
            document.getElementById('selectedCount').innerText = count;
            const btn = document.getElementById('genBtn');
            
            if (count > 0) {
                btn.disabled = false;
                btn.innerText = "ì›Œí¬ì‹œíŠ¸ ìƒì„±í•˜ê¸°";
            } else {
                btn.disabled = true;
                btn.innerText = "íŒ¨í„´ì„ ì„ íƒí•´ì£¼ì„¸ìš”";
            }
        }

        async function generatePDF() {
            const btn = document.getElementById('genBtn');
            btn.disabled = true;
            btn.innerText = 'ìƒì„± ì¤‘... â³';

            try {
                const response = await fetch('/generate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        book: currentBook,
                        patterns: Array.from(selectedPatterns) 
                    })
                });

                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    const shortBookName = currentBook.replace('.xlsx', '');
                    a.download = `Worksheet_${shortBookName}.pdf`;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    a.remove();
                    btn.innerText = 'ë‹¤ìš´ë¡œë“œ ì™„ë£Œ! âœ…';
                } else {
                    const err = await response.json();
                    alert('ì˜¤ë¥˜: ' + err.error);
                    btn.innerText = 'ì›Œí¬ì‹œíŠ¸ ìƒì„±í•˜ê¸°';
                }
            } catch (e) {
                alert('ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                btn.innerText = 'ì›Œí¬ì‹œíŠ¸ ìƒì„±í•˜ê¸°';
            } finally {
                setTimeout(() => {
                    if(selectedPatterns.size > 0) {
                        btn.disabled = false;
                        btn.innerText = 'ì›Œí¬ì‹œíŠ¸ ìƒì„±í•˜ê¸°';
                    }
                }, 2000);
            }
        }
    </script>
</body>
</html>