<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>ì˜ì–´ íŒ¨í„´ ì›Œí¬ì‹œíŠ¸ ìƒì„±ê¸°</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 30px;
        }
        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            padding: 40px;
        }
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
            font-size: 32px;
        }
        .upload-area {
            border: 3px dashed #667eea;
            border-radius: 15px;
            padding: 50px;
            text-align: center;
            background: #f8f9ff;
            margin-bottom: 30px;
            cursor: pointer;
            transition: all 0.3s;
        }
        .upload-area:hover { background: #e8ebff; }
        .upload-area.dragover { background: #d0d7ff; border-color: #4451b8; }
        .upload-icon { font-size: 60px; margin-bottom: 15px; }
        .file-info { margin-top: 15px; color: #667eea; font-weight: 600; }
        input[type="file"] { display: none; }
        label { display: block; margin-bottom: 10px; color: #555; font-weight: 600; font-size: 16px; }
        .pattern-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
            gap: 12px;
            max-height: 400px;
            overflow-y: auto;
            padding: 20px;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            background: #fafafa;
            margin-bottom: 20px;
        }
        .pattern-item {
            display: flex;
            align-items: center;
            padding: 15px;
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .pattern-item:hover { border-color: #667eea; background: #f8f9ff; transform: translateY(-2px); }
        .pattern-item.selected { background: #667eea; color: white; border-color: #667eea; }
        .pattern-item.disabled { opacity: 0.4; cursor: not-allowed; }
        .pattern-item input[type="checkbox"] { margin-right: 12px; width: 20px; height: 20px; cursor: pointer; }
        .pattern-label { flex: 1; cursor: pointer; font-size: 15px; font-weight: 500; }
        .selection-info {
            text-align: center;
            padding: 15px;
            background: #fff3cd;
            border-radius: 10px;
            margin-bottom: 15px;
            color: #856404;
            font-weight: 600;
            font-size: 16px;
        }
        .selection-info.max { background: #f8d7da; color: #721c24; }
        .btn-deselect { 
            width: 100%;
            padding: 12px;
            background: #ff9800;
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            margin-bottom: 20px;
            transition: all 0.2s;
        }
        .btn-deselect:hover { background: #e68900; transform: translateY(-2px); }
        .btn-generate {
            width: 100%;
            padding: 18px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-size: 20px;
            border: none;
            border-radius: 10px;
            font-weight: 700;
            cursor: pointer;
            margin-top: 20px;
            transition: all 0.3s;
        }
        .btn-generate:hover { transform: translateY(-3px); box-shadow: 0 15px 30px rgba(102, 126, 234, 0.4); }
        .btn-generate:disabled { background: #ccc; cursor: not-allowed; transform: none; }
        .message {
            margin-top: 20px;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            font-weight: 500;
            display: none;
        }
        .message.success { background: #d4edda; color: #155724; }
        .message.error { background: #f8d7da; color: #721c24; }
        .tip { background: #e3f2fd; padding: 12px; border-radius: 8px; margin-bottom: 20px; color: #1565c0; font-size: 14px; text-align: center; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ“ ì˜ì–´ íŒ¨í„´ ì›Œí¬ì‹œíŠ¸ ìƒì„±ê¸°</h1>
        
        <div class="upload-area" id="uploadArea">
            <div class="upload-icon">ğŸ“</div>
            <div style="font-size: 20px; color: #666; margin-bottom: 10px;">ë°ì´í„°ë² ì´ìŠ¤ íŒŒì¼ì„ ë“œë˜ê·¸í•˜ê±°ë‚˜ í´ë¦­í•˜ì„¸ìš”</div>
            <div style="font-size: 14px; color: #999;">(.xlsx íŒŒì¼)</div>
            <div class="file-info" id="fileInfo"></div>
        </div>
        <input type="file" id="fileInput" accept=".xlsx">

        <div style="margin-bottom: 25px;">
            <label>íŒ¨í„´ ì„ íƒ (ìµœëŒ€ 5ê°œ)</label>
            <div class="tip">ğŸ’¡ ì›í•˜ëŠ” íŒ¨í„´ì„ í´ë¦­í•˜ì—¬ ì„ íƒí•˜ì„¸ìš” (ìµœëŒ€ 5ê°œê¹Œì§€)</div>
            <div class="selection-info" id="selectionInfo">ì„ íƒëœ íŒ¨í„´: 0ê°œ / ìµœëŒ€ 5ê°œ</div>
            <button class="btn-deselect" onclick="deselectAll()">ì „ì²´ í•´ì œ</button>
            <div class="pattern-grid" id="patternGrid"></div>
        </div>

        <button class="btn-generate" id="generateBtn" onclick="generateWorksheet()">ğŸ“„ ì›Œí¬ì‹œíŠ¸ ìƒì„±</button>
        <div class="message" id="message"></div>
    </div>

    <script>
        const MAX_SELECTION = 5;
        let patternsData = [];

        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const fileInfo = document.getElementById('fileInfo');
        const patternGrid = document.getElementById('patternGrid');
        const selectionInfo = document.getElementById('selectionInfo');
        const generateBtn = document.getElementById('generateBtn');
        const message = document.getElementById('message');

        uploadArea.addEventListener('click', () => fileInput.click());
        uploadArea.addEventListener('dragover', (e) => { e.preventDefault(); uploadArea.classList.add('dragover'); });
        uploadArea.addEventListener('dragleave', () => uploadArea.classList.remove('dragover'));
        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            if (e.dataTransfer.files.length > 0) {
                fileInput.files = e.dataTransfer.files;
                handleFileUpload(e.dataTransfer.files[0]);
            }
        });
        fileInput.addEventListener('change', (e) => { if (e.target.files.length > 0) handleFileUpload(e.target.files[0]); });

        async function handleFileUpload(file) {
            fileInfo.textContent = `ğŸ“ ${file.name}`;
            const formData = new FormData();
            formData.append('database', file);

            try {
                showMessage('ë°ì´í„°ë² ì´ìŠ¤ ë¡œë”© ì¤‘...', 'success');
                const response = await fetch('/upload_database', { method: 'POST', body: formData });
                const result = await response.json();

                if (result.success) {
                    patternsData = result.patterns;
                    console.log('íŒ¨í„´ ë°ì´í„°:', result.patterns);
                    console.log('ì²« ë²ˆì§¸ íŒ¨í„´:', result.patterns[0]);
                    renderPatternGrid(result.patterns);
                    showMessage(`${result.patterns.length}ê°œ íŒ¨í„´ ë¡œë“œ ì™„ë£Œ!`, 'success');
                } else {
                    showMessage('ì˜¤ë¥˜: ' + result.error, 'error');
                }
            } catch (error) {
                showMessage('ì—…ë¡œë“œ ì‹¤íŒ¨: ' + error.message, 'error');
            }
        }

        function renderPatternGrid(patterns) {
            patternGrid.innerHTML = '';
            // íŒ¨í„´ì„ ë²ˆí˜¸ìˆœìœ¼ë¡œ ì •ë ¬
            patterns.sort((a, b) => a.number - b.number);
            
            patterns.forEach(pattern => {
                const div = document.createElement('div');
                div.className = 'pattern-item';
                div.innerHTML = `
                    <input type="checkbox" id="pattern_${pattern.number}" value="${pattern.number}" onchange="handleCheckboxChange(this)">
                    <label class="pattern-label" for="pattern_${pattern.number}">${pattern.number}. ${pattern.name}</label>
                `;
                div.addEventListener('click', (e) => {
                    if (e.target.type !== 'checkbox' && !div.classList.contains('disabled')) {
                        const checkbox = div.querySelector('input[type="checkbox"]');
                        if (!checkbox.checked && getSelectedCount() >= MAX_SELECTION) {
                            showMessage(`ìµœëŒ€ ${MAX_SELECTION}ê°œê¹Œì§€ë§Œ ì„ íƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤`, 'error');
                            return;
                        }
                        checkbox.checked = !checkbox.checked;
                        handleCheckboxChange(checkbox);
                    }
                });
                patternGrid.appendChild(div);
            });
            updateSelectionCount();
        }

        function handleCheckboxChange(checkbox) {
            if (checkbox.checked && getSelectedCount() > MAX_SELECTION) {
                checkbox.checked = false;
                showMessage(`ìµœëŒ€ ${MAX_SELECTION}ê°œê¹Œì§€ë§Œ ì„ íƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤`, 'error');
                return;
            }
            updateSelectionCount();
            updateDisabledState();
        }

        function getSelectedCount() {
            return document.querySelectorAll('.pattern-item input[type="checkbox"]:checked').length;
        }

        function updateDisabledState() {
            const selectedCount = getSelectedCount();
            const maxReached = selectedCount >= MAX_SELECTION;
            document.querySelectorAll('.pattern-item').forEach(item => {
                const checkbox = item.querySelector('input[type="checkbox"]');
                if (!checkbox.checked && maxReached) {
                    item.classList.add('disabled');
                    checkbox.disabled = true;
                } else {
                    item.classList.remove('disabled');
                    checkbox.disabled = false;
                }
                item.classList.toggle('selected', checkbox.checked);
            });
        }

        function deselectAll() {
            document.querySelectorAll('.pattern-item input[type="checkbox"]').forEach(cb => {
                cb.checked = false;
                cb.disabled = false;
                cb.closest('.pattern-item').classList.remove('selected', 'disabled');
            });
            updateSelectionCount();
        }

        function updateSelectionCount() {
            const selected = getSelectedCount();
            selectionInfo.textContent = `ì„ íƒëœ íŒ¨í„´: ${selected}ê°œ / ìµœëŒ€ ${MAX_SELECTION}ê°œ`;
            selectionInfo.classList.toggle('max', selected >= MAX_SELECTION);
            updateDisabledState();
        }

        async function generateWorksheet() {
            const selectedPatterns = Array.from(document.querySelectorAll('.pattern-item input[type="checkbox"]:checked')).map(cb => parseInt(cb.value));
            if (selectedPatterns.length === 0) {
                showMessage('ìµœì†Œ 1ê°œ ì´ìƒì˜ íŒ¨í„´ì„ ì„ íƒí•´ì£¼ì„¸ìš”', 'error');
                return;
            }

            try {
                generateBtn.disabled = true;
                showMessage('ì›Œí¬ì‹œíŠ¸ ìƒì„± ì¤‘...', 'success');

                const response = await fetch('/generate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ patterns: selectedPatterns })
                });

                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `Worksheet_Patterns_${selectedPatterns.join('_')}_${new Date().toISOString().split('T')[0]}.pdf`;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                    showMessage(`âœ… ì›Œí¬ì‹œíŠ¸ ìƒì„± ì™„ë£Œ! (íŒ¨í„´ ${selectedPatterns.length}ê°œ)`, 'success');
                } else {
                    const result = await response.json();
                    showMessage('ì˜¤ë¥˜: ' + result.error, 'error');
                }
            } catch (error) {
                showMessage('ìƒì„± ì‹¤íŒ¨: ' + error.message, 'error');
            } finally {
                generateBtn.disabled = false;
            }
        }

        function showMessage(text, type) {
            message.textContent = text;
            message.className = 'message ' + type;
            message.style.display = 'block';
            if (type === 'success') setTimeout(() => message.style.display = 'none', 3000);
        }
    </script>
</body>
</html>
